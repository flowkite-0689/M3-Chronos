# M3-Chronos - STM32F103C8T6智能手表项目

## 项目概述

M3-Chronos是一个基于STM32F103C8T6微控制器的智能手表项目，采用FreeRTOS实时操作系统，具备完整的用户界面框架和多种实用功能。

## 硬件平台

- **主控芯片**: STM32F103C8T6 (Cortex-M3内核，72MHz主频)
- **显示屏**: 0.96寸OLED (128x64分辨率，SSD1306驱动)
- **传感器**: MPU6050六轴运动传感器（加速度计+陀螺仪）
- **输入设备**: 4个独立按键
- **时钟模块**: 内置RTC实时时钟
- **声音提示**: 蜂鸣器
- **环境传感器**: DHT11温湿度传感器

## 软件架构

### 操作系统
- **FreeRTOS v10.x**: 实时多任务操作系统
- **任务调度**: 优先级抢占式调度
- **内存管理**: Heap_4内存分配算法

### 核心框架
- **统一菜单框架**: 自主开发的页面管理系统
- **事件驱动**: 基于队列的事件处理机制
- **多任务协同**: 菜单、按键、计步、闹钟独立任务

## 功能特性

### 1. 时间显示功能
- 实时时钟显示（时:分:秒）
- 日期显示（年/月/日）
- 星期显示
- 时间进度条可视化

### 2. 健康监测
- **计步器**: 基于MPU6050的运动检测
- **步数统计**: 实时步数显示和累计
- **运动状态识别**: 行走/跑步状态检测

### 3. 闹钟系统
- 多组闹钟设置
- 闹钟提醒功能
- 闹钟事件处理

### 4. 实用工具
- **秒表**: 精确计时功能
- **温湿度监测**: DHT11传感器数据读取
- **空气质量检测**: 预留接口
- **2048游戏**: 休闲娱乐功能

### 5. 系统设置
- 时间设置
- 日期设置
- 系统参数配置

## 菜单框架设计

### 框架特点
- **统一架构**: 支持横向图标菜单和竖向列表菜单
- **类型化设计**: 三种菜单类型（图标、列表、自定义）
- **事件驱动**: 基于FreeRTOS队列的事件处理
- **内存管理**: 动态内存分配与释放

### 菜单类型
1. **横向图标菜单 (MENU_TYPE_HORIZONTAL_ICON)**
   - 主界面导航
   - 图标化显示
   - 左右滑动切换

2. **竖向列表菜单 (MENU_TYPE_VERTICAL_LIST)**
   - 设置菜单
   - 列表式显示
   - 上下选择导航

3. **自定义页面 (MENU_TYPE_CUSTOM)**
   - 特殊功能页面
   - 完全自定义绘制
   - 独立交互逻辑

### 技术实现
```c
typedef struct menu_item {
    const char *name;                    // 菜单项名称
    menu_type_t type;                   // 菜单类型
    menu_content_t content;             // 显示内容
    // ... 其他字段
} menu_item_t;
```

## 项目结构

```
M3-Chronos/
├── Libraries/          # STM32标准库
├── Output/            # 编译输出文件
├── Project/           # 工程配置文件
└── User/              # 用户代码
    ├── FreeRTOS/      # FreeRTOS源码
    ├── Hardware/      # 硬件驱动
    │   ├── OLED/      # OLED显示驱动
    │   ├── MPU6050/   # 运动传感器驱动
    │   └── Key/       # 按键驱动
    ├── System/        # 系统功能
    ├── ui/            # 用户界面
    │   ├── Inc/       # 头文件
    │   └── Src/       # 源文件
    ├── alarm/         # 闹钟功能
    └── main.c         # 主程序
```

## 内存管理现状

### 当前限制
- **动态创建问题**: 菜单项的动态创建和删除存在内存泄漏风险
- **静态创建**: 目前主要采用静态创建方式确保稳定性
- **内存监控**: 实现了详细的内存分配/释放日志

### 内存分配策略
```c
// 菜单项创建
menu_item_t* menu_item_create(const char *name, menu_type_t type, menu_content_t content)
{
    menu_item_t *item = (menu_item_t*)pvPortMalloc(sizeof(menu_item_t));
    // ... 初始化逻辑
}

// 子菜单数组管理
menu_item_t **new_children = (menu_item_t **)pvPortMalloc(
    sizeof(menu_item_t *) * (parent->child_count + 1)
);
```

## 编译与部署

### 开发环境
- **IDE**: Keil MDK-ARM
- **编译器**: ARMCC
- **调试器**: ST-Link

### 编译步骤
1. 打开 `Project/M3-Chronos.uvprojx` 工程文件
2. 配置正确的芯片型号 (STM32F103C8T6)
3. 设置正确的晶振频率 (8MHz)
4. 编译并下载到目标板

### 调试工具
- 串口调试 (printf输出)
- 内存使用监控
- 任务状态查看

## 已知问题与改进方向

### 当前问题
1. **内存泄漏风险**: 动态菜单创建/删除机制需要优化
2. **稳定性**: 复杂菜单操作可能引起系统不稳定
3. **资源管理**: 内存碎片化问题需要关注

### 改进计划
1. **内存池管理**: 实现专用的菜单内存池
2. **静态配置优化**: 改进静态菜单配置方式
3. **错误恢复**: 增强系统异常处理能力
4. **性能优化**: 优化显示刷新和事件处理效率

## 贡献指南

欢迎对项目进行改进和优化，特别是在以下方面：
- 菜单框架的内存管理优化
- 新功能的添加和实现
- 代码结构和性能优化
- 文档完善和测试用例

## 许可证

本项目采用MIT开源许可证，详见LICENSE文件。

## 联系方式

- **作者**: flowkite-0689
- **版本**: v1.0
- **日期**: 2025年12月

---

*注意：本项目仍在持续开发中，部分功能可能尚未完全稳定。建议在熟悉STM32和FreeRTOS的基础上进行二次开发。*